# 第十二章 分片（sharding）

分片是指，可以在多台计算机上分布数据。

## 分片的必要性

一台数据库服务器每秒只能处理有限的查询，网络接口和磁盘驱动器每秒也只能从web服务器传输有限兆字节的数据。

复制集可以解决一些扩展性的问题，允许在多个服务器上创建多个同样的数据库复制集，可以将服务器负载分散到更多计算机上。

## 分割水平和垂直数据

数据分区是分割多个独立的数据库中的数据的机制，这些数据可以共存（在同一个系统中），或远程（在单独的系统中）存储。

共存数据分区的动力是减小每个索引的大小，减少为了更新数据所需的输入/输出（I/O）数据量。

远程数据分区的动力是通过拥有更多的用于存储数据的RAM、通过避免硬盘访问、通过拥有更多的网络接口、通过拥有更多的硬盘输入/输出（I/O）通道，以增加访问数据的带宽。

### 垂直分割数据

垂直分区包括分解列数据和将此部分数据存储在单独的表或集合中。

在关系型数据库中，使用具有一对一关系的联接表就是垂直分区的一种形式。

但是MongoDB中不支持这种形式，因为数据在MongoDB中不是以简单的行列形式存储的。

### 水平分割数据

水平分区是MongoDB中的唯一分区方式，分片（sharding）是常用的一种方法。

分片允许在不同服务器之间分割集合，以提升包含大量文档的集合的性能

例如，当将一组用户记录分片在一组服务器上时，所有姓氏字母以A-G开头的人记录在一个服务器上，H-M的记录在另一个服务器上，以此类推。

分割数据时使用的规则叫做分片键。

+ MongoDB有一种独特的分片方法，即<mongos路由进程>管理 数据的分割和请求到所需分片服务器的路线。如果查询需要从多个分片获取数据，mongos会管理把从每一个分片中获得的数据合并回单个游标这个过程。

*这项功能使MongoDB成为了面向云或者面向Web的数据库*

## 分析一个简单的分片场景

使用分片键时，可能会造成分片不均匀，有一部分存储的数据多，一部分存储的数据少这种情况。

+ 要求1：分片系统最重要的特征就在于，必须确保数据在服务器之间是均匀分布的。这样可以防止限制水平缩放性能的hotspots。

+ 要求2：当将数据集分散到各个服务器时，会减少“一个服务器故障导致所有数据不可用”的机会，但是增加了服务器故障的机会和数量。所以，MongoDB需要拥有以容错方式存储分片数据的能力。
+ 要求3：MongoDB需要能够在系统运行时添加或移除分片。

## 在MongoDB中运行分片

MongoDB使用代理机制（proxy mechanism）来支持分片。提供的mongos守护（daemon）进程充当多个基于mongod的分片服务器的控制器。应用程序附加到mongos进程中，就好像它是一个单独的MongoDB数据库服务器。之后，应用程序将所有命令（更新、查询、删除）都发送到该mongos进程中。

mongos进程负责管理从应用程序发送命令的MongoDB服务器；守护进程重新发出从多个分片到多个服务器的查询，并将结果汇总在一起。

**MongoDB可以实现集合级别的分片，不是数据库级别，在系统中可能只有一两个集合增长到需要分片的程度**

+ 分片原理：

  分片系统使用分片键将数据映射为块（chunks）(即文档键的逻辑连续范围)。 每个块标识一些具有特定连续分片键值范围的文档；这些值使 mongos 控制器能够快速找到包含需要处理的文档的块。然后， Mongodb 的分片系统将这个块存储在一个可用的分片存储中； 配置服务器（config server）跟踪哪个分片存储在哪个分片服务器上。

   这是进行分片的一个重要特性，因为它允许您从集群中添加和删除分片，而无需备份和恢复数据。 

+ 配置服务器（config server）：存储分片的配置文件，存储在集合中每个分片服务器的信息。还充当目录（directories），用于确定每个块的位置。

  ***至少使用三个配置服务器***

### 建立分片配置

1. 建立配置服务器

打开命令行窗口，为成员提供一个名为“config”的复制集，并保持打开

```
mkdir -p db\config\data
mongod --port 27022 --dbpath db\config\data --configsvr --replSet config
```

因为创建的是一个config复制集，所以需要初始化，打开一个新的命令行窗口

```
mongo --port 27022
>rs.initiate()
```

2. 创建分片控制器（mongos）

打开新的命令行窗口，创建分片控制器，监听端口27021。chunksize设为最小1MB（实际中chunksize不能小于文档的最大size（16MB），默认情况下chunksize为64MB。

```
mongos --configdb config/<hostname>:27022 --port 27021 
```

更改chunksize

```
>use config
>db.settings.save({_id:"chunksize",value:<sizeInMB>})
```

3. 创建两个分片服务器

新建两个命令行窗口

```
mkdir -p db\shard0\data
mongod --port 27023 --dbpath db\shard0\data
```

```
mkdir -p db\shard1\data
mongod --port 27024 --dbpath db\shard1\data
```

4. 告诉分片系统分片服务器的位置

```
mongo <hostname>:27021
>sh.addShard("<hostname>:27023")
>sh.addShard("<hostname>:27024")
```

检查分片系统状态

```
>db.printShardingStatus()
```

即成功建立了分片工作环境

5. 输入分片数据

创建testdb数据库，testcollection集合，将该集合分片

```
>sh.enableSharding("testdb")
>sh.shardCollection("testdb.testcollection"，{testkey:1})
```

现在就已经建立了拥有两个分片存储服务器的分片集。





























































